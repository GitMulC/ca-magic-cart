version: 2.1

executors:
  ruby-executor:
    docker:
      - image: cimg/ruby:3.2.3-node

orbs:
  ruby: circleci/ruby@1.1.0

jobs:
  test:
    executor: ruby-executor
    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: Set up database
          command: |
            bundle exec rake db:create RAILS_ENV=test
            bundle exec rake db:schema:load RAILS_ENV=test
      - run:
          name: Run tests
          command: bundle exec rails test

  build:
    docker:
      - image: cimg/ruby:3.2.3-node
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.7
          docker_layer_caching: true
      - run:
          name: Docker login
          command: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run:
          name: Build Docker image
          command: docker build -t $IMAGE_NAME:latest . --build-arg SECRET_KEY_BASE=$SECRET_KEY_BASE
      - run:
          name: Push Docker image
          command: docker push $IMAGE_NAME
      - run:
          name: Run Docker image
          command: docker run -d --name $CONTAINER_NAME -p 3000:3000 $IMAGE_NAME

  deploy:
    docker:
      - image: cimg/ruby:3.2.3-node
    steps:
      - run:
          name: Deploy application
          command: |
            ssh -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_PUBLIC_DNS << 'EOF'
              export CONTAINER_NAME="$CONTAINER_NAME"
              export IMAGE_NAME="$IMAGE_NAME"
              cd /path/to/your/application || exit
              docker stop $CONTAINER_NAME || true
              docker rm $CONTAINER_NAME || true
              docker pull $IMAGE_NAME
              docker run -d --name $CONTAINER_NAME -p 3000:3000 $IMAGE_NAME
            EOF
